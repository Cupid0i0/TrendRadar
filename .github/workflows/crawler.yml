name: Hot News Crawler

on:
  schedule:
    - cron: "0 * * * *"  # æ¯å°æ—¶æ‰§è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆä¼˜å…ˆç”¨è¿™ä¸ªæµ‹è¯•ï¼‰

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    # å¼€å¯è°ƒè¯•æ—¥å¿—ï¼ˆå…³é”®ï¼‰
    env:
      PYTHONUNBUFFERED: "1"  # å¼ºåˆ¶Pythonè¾“å‡ºå®æ—¶åˆ·æ–°ï¼ˆé¿å…æ—¥å¿—ç¼“å­˜ï¼‰
      DEBUG: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        # æ‰“å°æ£€å‡ºä¿¡æ¯
        with:
          fetch-depth: 1
        env:
          ACTIONS_STEP_DEBUG: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Show Python version  # æ–°å¢ï¼šéªŒè¯Pythonç¯å¢ƒ
        run: |
          python --version
          pip --version

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ å¼€å§‹å®‰è£…ä¾èµ–..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # æ‰“å°å·²å®‰è£…çš„åŒ…ï¼ˆæ’æŸ¥ä¾èµ–ç¼ºå¤±ï¼‰
          pip list
          echo "ğŸ”§ å®‰è£…Playwrightä¾èµ–..."
          playwright install --with-deps
          # éªŒè¯Playwrightå®‰è£…
          playwright --version
        # ä¾èµ–å®‰è£…å¤±è´¥æ—¶ä¿ç•™æ—¥å¿—
        continue-on-error: false

      - name: Verify required files
        run: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„é…ç½®æ–‡ä»¶..."
          # æ‰“å°ç›®å½•ç»“æ„ï¼ˆå…³é”®ï¼šç¡®è®¤æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼‰
          ls -la ./
          ls -la ./config/ || echo "âš ï¸ configç›®å½•ä¸å­˜åœ¨"
          
          if [ ! -f config/config.yaml ]; then
            echo "âŒ é”™è¯¯: config/config.yaml æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ é”™è¯¯: config/frequency_words.txt æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: Run crawler
        env:
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          GITHUB_ACTIONS: true
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œçˆ¬è™«è„šæœ¬..."
          # æ‰“å°ç¯å¢ƒå˜é‡ï¼ˆæ’æŸ¥ç§˜é’¥æ˜¯å¦åŠ è½½ï¼Œæ³¨æ„ï¼šæ•æ„Ÿä¿¡æ¯ä¼šè„±æ•ï¼‰
          echo "EMAIL_FROM: $EMAIL_FROM"
          echo "EMAIL_TO: $EMAIL_TO"
          # æ‰§è¡Œè„šæœ¬å¹¶æ‰“å°è¯¦ç»†æ—¥å¿—
          python -u main.py  # -u å¼ºåˆ¶æ— ç¼“å†²è¾“å‡º
        # è„šæœ¬æ‰§è¡Œå¤±è´¥æ—¶ä¸ç»ˆæ­¢ï¼Œç»§ç»­æ‰“å°æ—¥å¿—
        continue-on-error: true

      - name: Show crawler output (debug)  # æ–°å¢ï¼šå¦‚æœè„šæœ¬æœ‰è¾“å‡ºæ–‡ä»¶ï¼Œæ‰“å°å†…å®¹
        run: |
          echo "ğŸ“„ æ£€æŸ¥è„šæœ¬è¾“å‡ºæ–‡ä»¶..."
          # æ›¿æ¢ä¸ºä½ çš„è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆæ¯”å¦‚çˆ¬å–ç»“æœæ–‡ä»¶ï¼‰
          ls -la ./output/ || echo "âš ï¸ outputç›®å½•ä¸å­˜åœ¨"
          cat ./output/result.txt || echo "âš ï¸ è¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨"

      - name: Commit and push if changes
        run: |
          echo "ğŸ”— é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          # æ‰“å°GitçŠ¶æ€ï¼ˆæ’æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼‰
          git status
          git add -A
          # æ‰“å°diffï¼ˆç¡®è®¤å˜æ›´å†…å®¹ï¼‰
          git diff --staged
          # æäº¤å¹¶æ¨é€
          if git diff --quiet && git diff --staged --quiet; then
            echo "â„¹ï¸ æ— æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "Auto update by GitHub Actions at $(TZ=Asia/Shanghai date)"
            echo "ğŸ“¤ æ¨é€å˜æ›´åˆ°ä»“åº“..."
            git push
            echo "âœ… æ¨é€æˆåŠŸ"
          fi
        # æ¨é€å¤±è´¥æ—¶æ‰“å°é”™è¯¯
        continue-on-error: false
